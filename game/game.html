<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Go Bananas</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var SCREEN_WIDTH = 800;
var SCREEN_HEIGHT = 600
var GAME_WIDTH = 800;
var GAME_HEIGHT = SCREEN_HEIGHT*2;
var CAMERA_LOCATION = SCREEN_HEIGHT;
var CAMERA_ADJUSTMENT = 10;

var MONKEY_WIDTH = 80;
var MONKEY_HEIGHT = 69;
var GROUND_HEIGHT = 64;
var game = new Phaser.Game(SCREEN_WIDTH, SCREEN_HEIGHT, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var bananaTimer;
function preload() {

    game.load.spritesheet('monkey', 'assets/img/monkey_sprites.png', MONKEY_WIDTH, MONKEY_HEIGHT);
    game.load.image("bed", "assets/img/bed.png");
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/img/banana.png');
    game.load.image('sky', 'assets/sky.png');
    game.load.image('jungle', 'assets/img/jungle.png');

    game.load.audio('bite', 'assets/audio/bite.mp3');

}

var player;
var platforms;
var cursors;

var stars;
var score = 0;
var scoreText;

//Holds the two monkeys
var monkeyOne;
var monkeyTwo;
//Points to the monkey currently in the air
var monkeyJumping;
var otherMonkey;
//Checks if monkey is in the air
var isJumping = true;

var landingDistance = 0;
var jumpSpeed = 0;
var defaultJumpSpeed = SCREEN_HEIGHT;
var scoreToJumpRatio = SCREEN_HEIGHT/1000;

//Gravity
var gravity = 200;
var platforms;

//Sounds
var biteSFX;

//Timer variables
var gameEnded = false;
var bananaTimer;
var timerCounter = 60;
var timerText;


function create() {

    //Sets the bound of the world
    game.world.setBounds(0, 0, GAME_WIDTH, GAME_HEIGHT);

    //Camera
    game.camera.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
    //adjustCameraLocation(0);
    game.camera.setPosition(0, CAMERA_LOCATION);


    //Creates the background
    game.add.sprite(0, GAME_HEIGHT - SCREEN_HEIGHT, "jungle");
    game.add.sprite(0, 0, "sky");

    //Creates the platforms group
    platforms = game.add.group();
    var bed = platforms.create(0, GAME_HEIGHT - GROUND_HEIGHT, "bed");
    bed.scale.setTo(2, 2);
    game.physics.enable(bed);
    bed.body.immovable = true;

    // The player and its settings
    monkeyOne = initializeMonkey(monkeyOne, 0, SCREEN_HEIGHT + MONKEY_HEIGHT, game);
    monkeyTwo = initializeMonkey(monkeyTwo, GAME_WIDTH - MONKEY_WIDTH, GAME_HEIGHT - GROUND_HEIGHT -MONKEY_HEIGHT, game);
    monkeyJumping = monkeyOne;
    otherMonkey = monkeyTwo;

    //  Finally some stars to collect
    stars = game.add.group();

    generateBananas(stars, 24);

    // The sounds
    biteSFX = game.add.audio("bite");
    biteSFX.addMarker("happy", 0, 0.69, 1, false);
    //  The score
    scoreText = game.add.text(16, game.camera.y + 16, 'Score: 0', { fontSize: '32px', fill: '#000' });

    //  Our controls.


    cursors = game.input.keyboard.createCursorKeys();

    // Implement time limit (start off with 60 seconds for a round)
    game.time.events.add(Phaser.Timer.SECOND * 60, endGame, this);
    game.time.events.loop(Phaser.Timer.SECOND, generateBananas, this, stars, 2);
    game.time.events.loop(Phaser.Timer.SECOND, updateTimer, this);

    timerText = game.add.text(600, 816, 'Time left: 60', {fontSize: '32px', fill: '#000'});
}

function updateTimer(){
    timerCounter = Math.max(0,timerCounter - 1);
}

function endGame() {
    //stop sprites, do something with score
    gameEnded = true;
}

function switchMonkey() {
    //Sets the monkey to default movement
    monkeyJumping.body.velocity.x = 0;
    monkeyJumping.animations.stop();

    //Updates the landing distance of the jumping monkey relative to the monkey on ground
    landingDistance = Math.abs(monkeyTwo.body.x - monkeyOne.body.x);

    if (monkeyJumping == monkeyOne) {
        monkeyJumping = monkeyTwo;
        otherMonkey = monkeyOne;
    } else {
        monkeyJumping = monkeyOne;
        otherMonkey = monkeyTwo;
    }
    isJumping = false;
}

function update() {

    collisionUpdate();
    cameraUpdate();

    if (!gameEnded) {
        // Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
        game.physics.arcade.overlap(monkeyJumping, stars, collectStar, null, this);

        controls();
        timerText.setText('Time left: ' + timerCounter);
    } else {
        monkeyJumping.animations.stop();
        monkeyJumping.body.velocity.x = 0;
        timerText.setText('Time left: 0');
        game.physics.arcade.collide(monkeyOne, platforms);
        game.physics.arcade.collide(monkeyTwo, platforms);
    }
}
    /*
    Function: Generates a specified amount of banana sprites 
    @param: bananas: the group in which a banana will be added to
    @param: amountOfBananas: the amount of bananas being generated
    */

function generateBananas(bananas, amountOfBananas) {
    if (gameEnded != true) {
        for (var i = 0; i < amountOfBananas; i++) {
            //console.log(i);
            //  Create a banana inside of the 'bananas' group
            var banana = bananas.create(Math.random() * (SCREEN_WIDTH-26) + 26, Math.random() * GAME_HEIGHT - SCREEN_HEIGHT, 'star');

            game.physics.enable(banana);
            //  Let gravity do its thing
            banana.body.gravity.y = gravity/5;

            //  This just gives each star a slightly random bounce value
            banana.body.bounce.y = 0.7 + Math.random() * 0.2;
        }
    }
}

function collectStar(monkey, star) {
    // Removes the star from the screen
    star.kill();

    //  Add and update the score
    score += 10;
    scoreText.setText('Score: ' + score);

    biteSFX.play("happy", 0, 0.5, false, true);
}

function initializeMonkey(monkey, startingX, startingY, game) {
    // The player and its settings
    monkey = game.add.sprite(startingX, startingY, 'monkey', 4);

    game.physics.enable(monkey);

    //  Player physics properties. Give the little guy a slight bounce.
    monkey.body.bounce.y = 0;
    monkey.body.gravity.y = gravity; //gravedad
    monkey.body.collideWorldBounds = true; //choque con los bordes del juego

    //  Our two animations, walking left and right.
    monkey.animations.add('left', [0, 1, 2, 3], 10, true);
    monkey.animations.add('right', [33, 32, 31, 30], 10, true);

    return monkey;
}

    //Collide the player and the stars with the platforms
function collisionUpdate() {
    game.physics.arcade.collide(stars, platforms, removeBanana, null, this);
    game.physics.arcade.collide(monkeyJumping, platforms, switchMonkey);
    game.physics.arcade.collide(otherMonkey, platforms);
}
    //Updates the camera position, as well as score and timer text
function cameraUpdate() {  
    game.camera.setPosition(0,
        Math.min(monkeyJumping.body.y - game.camera.height / 2, SCREEN_HEIGHT));
    scoreText.y = game.camera.y + 16;
    timerText.y = game.camera.y + 16;
}

    //Updates jump height
function jumpSpeedUpdate() {
    jumpSpeed = defaultJumpSpeed * (Math.max(1 / 2, landingDistance / GAME_WIDTH)) + score * scoreToJumpRatio;
}

//Debug function to get coordinate of mouse
function mouseDebugger() {
    if (game.input.mousePointer.isDown) {
        console.log(game.input.mousePointer.position);
    }
}

/*
Adjusts camera location
@param: int adjustment, which adjusts camera location
*/
function adjustCameraLocation(adjustment) {
    CAMERA_LOCATION = Math.min(Math.max(0,CAMERA_LOCATION-adjustment),SCREEN_HEIGHT);
    game.camera.setPosition(0, CAMERA_LOCATION);
}


//Controls for camera movement
function cameraControls() {
    if (cursors.up.isDown) {
        adjustCameraLocation(CAMERA_ADJUSTMENT);
    } else if (cursors.down.isDown) {
        adjustCameraLocation(-1 * CAMERA_ADJUSTMENT);
    }
}


function removeBanana(banana, ground) {
    banana.kill();
}

function controls() {
    //  Reset the players velocity (movement)
    monkeyJumping.body.velocity.x = 0;
    if (isJumping) {
        if (cursors.left.isDown) 
        {
            //  Move to the left
            monkeyJumping.body.velocity.x = -150;
            monkeyJumping.animations.play('left');
        }
        else if (cursors.right.isDown) {
            //  Move to the right
            monkeyJumping.body.velocity.x = 150;
            monkeyJumping.animations.play('right');
        }
        else {
            //   Stand still
            monkeyJumping.animations.stop();
        }        
    } else {
        jumpSpeedUpdate();
        monkeyJumping.body.velocity.y = -jumpSpeed;
        isJumping = true;
    }

}
</script>

</body>
</html>